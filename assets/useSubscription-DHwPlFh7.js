import{j as O,c as q,w as j,q as p,aV as M,o as k,C as I}from"./index-rSJcjQqR.js";import{L as A,O as C,q as F,o as K}from"./SideBar-6zVQ4zFe.js";let E=0;const{setActiveSubscriptions:N}=A();setInterval(()=>{N(E)},1e3);const U=({eose:e,limit:r,eoseLimit:b})=>{const[i,n]=q([]),o=[];let c;const l=()=>{n(s=>{const t=[...s];return o.forEach(u=>{C(t,u)}),t.slice(0,b())}),o.splice(0,o.length)},g=()=>{c==null&&(c=setTimeout(()=>{c=void 0,l()},100))},a=()=>{c!=null&&clearTimeout(c)},f=s=>{const t=s.created_at-F();if(!(t>300)){if(t>0){setTimeout(()=>f(s),t*1e3);return}e()?n(u=>{const d=[...u];return C(d,s),d.slice(0,r())}):(o.push(s),g())}},S=()=>{n([]),a()};return p(()=>{e()&&l()}),I(()=>{a()}),{events:i,setEvents:n,addEvent:f,clearEvents:S}},_=e=>{const{config:r,shouldMuteEvent:b}=O(),T=K(),[i,n]=q(!1),o=j(e),c=()=>e()?.eoseLimit??25,l=()=>e()?.limit??50,{events:g,addEvent:a,clearEvents:f,setEvents:S}=U({eose:i,eoseLimit:c,limit:l});p(M(()=>[r().mutedPubkeys,r().mutedKeywords],()=>{S(t=>t.filter(u=>!b(u)))},{defer:!0})),k(()=>{console.debug("subscription mounted",e()?.debugId,e()),I(()=>{console.debug("subscription unmount",e()?.debugId,e())})});const s=()=>{console.debug("startSubscription: start");const t=o();if(t==null)return;const{relayUrls:u,filters:d,options:x,onEvent:h,onEOSE:y,clientEventFilter:w,continuous:D=!0}=t;let m=!0;E+=1,f(),n(!1);const L=T().subscribeMany(u,d,x??{maxWait:12e3,onevent:v=>{h?.(v),!(w!=null&&!w(v))&&a(v)},oneose:()=>{i()||(y?.(),n(!0),D||(L.close(),m&&(m=!1,E-=1)))}});I(()=>{console.debug("startSubscription: end"),L.close(),m&&(m=!1,E-=1)})};return p(M(()=>[o()],()=>s())),{events:g,eose:i}};export{_ as u};
//# sourceMappingURL=useSubscription-DHwPlFh7.js.map
