import{j as K,c as A,r as j,q as p,aR as L,o as k,A as I}from"./index-CbXZld-o.js";import{J as q,K as x,n as F,m as J}from"./SideBar-QP03rlVs.js";let E=0;const{setActiveSubscriptions:N}=q();setInterval(()=>{N(E)},1e3);const O=({eose:e,limit:r,eoseLimit:b})=>{const[i,n]=A([]),o=[];let c;const l=()=>{n(s=>{const t=[...s];return o.forEach(u=>{x(t,u)}),t.slice(0,b())}),o.splice(0,o.length)},g=()=>{c==null&&(c=setTimeout(()=>{c=void 0,l()},100))},a=()=>{c!=null&&clearTimeout(c)},f=s=>{const t=s.created_at-F();if(!(t>300)){if(t>0){setTimeout(()=>f(s),t*1e3);return}e()?n(u=>{const d=[...u];return x(d,s),d.slice(0,r())}):(o.push(s),g())}},S=()=>{n([]),a()};return p(()=>{e()&&l()}),I(()=>{a()}),{events:i,setEvents:n,addEvent:f,clearEvents:S}},W=e=>{const{config:r,shouldMuteEvent:b}=K(),T=J(),[i,n]=A(!1),o=j(e),c=()=>e()?.eoseLimit??25,l=()=>e()?.limit??50,{events:g,addEvent:a,clearEvents:f,setEvents:S}=O({eose:i,eoseLimit:c,limit:l});p(L(()=>[r().mutedPubkeys,r().mutedKeywords],()=>{S(t=>t.filter(u=>!b(u)))},{defer:!0})),k(()=>{console.debug("subscription mounted",e()?.debugId,e()),I(()=>{console.debug("subscription unmount",e()?.debugId,e())})});const s=()=>{console.debug("startSubscription: start");const t=o();if(t==null)return;const{relayUrls:u,filters:d,options:C,onEvent:h,onEOSE:y,clientEventFilter:M,continuous:D=!0}=t;let m=!0;E+=1,f(),n(!1);const w=T().subscribeMany(u,d,C??{maxWait:12e3,onevent:v=>{h?.(v),!(M!=null&&!M(v))&&a(v)},oneose:()=>{i()||(y?.(),n(!0),D||(w.close(),m&&(m=!1,E-=1)))}});I(()=>{console.debug("startSubscription: end"),w.close(),m&&(m=!1,E-=1)})};return p(L(()=>[o()],()=>s())),{events:g,eose:i}};export{W as u};
//# sourceMappingURL=useSubscription-CPqs05Fd.js.map
