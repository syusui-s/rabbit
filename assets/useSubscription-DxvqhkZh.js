import{j as A,c as L,r as j,q as p,aQ as C,o as k,A as I}from"./index-BfvyELJb.js";import{C as F,D,q as K,m as N}from"./SideBar-PatyVfXs.js";let E=0;const{setActiveSubscriptions:O}=F();setInterval(()=>{O(E)},1e3);const Q=({eose:e,limit:r,eoseLimit:b})=>{const[i,n]=L([]),o=[];let c;const l=()=>{n(s=>{const t=[...s];return o.forEach(u=>{D(t,u)}),t.slice(0,b())}),o.splice(0,o.length)},g=()=>{c==null&&(c=setTimeout(()=>{c=void 0,l()},100))},a=()=>{c!=null&&clearTimeout(c)},f=s=>{const t=s.created_at-K();if(!(t>300)){if(t>0){setTimeout(()=>f(s),t*1e3);return}e()?n(u=>{const d=[...u];return D(d,s),d.slice(0,r())}):(o.push(s),g())}},S=()=>{n([]),a()};return p(()=>{e()&&l()}),I(()=>{a()}),{events:i,setEvents:n,addEvent:f,clearEvents:S}},_=e=>{const{config:r,shouldMuteEvent:b}=A(),T=N(),[i,n]=L(!1),o=j(e),c=()=>e()?.eoseLimit??25,l=()=>e()?.limit??50,{events:g,addEvent:a,clearEvents:f,setEvents:S}=Q({eose:i,eoseLimit:c,limit:l});p(C(()=>[r().mutedPubkeys,r().mutedKeywords],()=>{S(t=>t.filter(u=>!b(u)))},{defer:!0})),k(()=>{console.debug("subscription mounted",e()?.debugId,e()),I(()=>{console.debug("subscription unmount",e()?.debugId,e())})});const s=()=>{console.debug("startSubscription: start");const t=o();if(t==null)return;const{relayUrls:u,filters:d,options:q,onEvent:h,onEOSE:y,clientEventFilter:M,continuous:x=!0}=t;let m=!0;E+=1,f(),n(!1);const w=T().subscribeMany(u,d,q??{maxWait:12e3,onevent:v=>{h?.(v),!(M!=null&&!M(v))&&a(v)},oneose:()=>{i()||(y?.(),n(!0),x||(w.close(),m&&(m=!1,E-=1)))}});I(()=>{console.debug("startSubscription: end"),w.close(),m&&(m=!1,E-=1)})};return p(C(()=>[o()],()=>s())),{events:g,eose:i}};export{_ as u};
//# sourceMappingURL=useSubscription-DxvqhkZh.js.map
