import{j as C,c as q,r as j,q as I,aR as D,o as k,A as p}from"./index-Dbx9Ji0-.js";import{D as F,I as L,q as K,m as N}from"./SideBar-BE_N61gf.js";let E=0;const{setActiveSubscriptions:O}=F();setInterval(()=>{O(E)},1e3);const R=({eose:e,limit:r,eoseLimit:b})=>{const[i,n]=q([]),o=[];let c;const l=()=>{n(s=>{const t=[...s];return o.forEach(u=>{L(t,u)}),t.slice(0,b())}),o.splice(0,o.length)},g=()=>{c==null&&(c=setTimeout(()=>{c=void 0,l()},100))},a=()=>{c!=null&&clearTimeout(c)},f=s=>{const t=s.created_at-K();if(!(t>300)){if(t>0){setTimeout(()=>f(s),t*1e3);return}e()?n(u=>{const d=[...u];return L(d,s),d.slice(0,r())}):(o.push(s),g())}},S=()=>{n([]),a()};return I(()=>{e()&&l()}),p(()=>{a()}),{events:i,setEvents:n,addEvent:f,clearEvents:S}},_=e=>{const{config:r,shouldMuteEvent:b}=C(),T=N(),[i,n]=q(!1),o=j(e),c=()=>e()?.eoseLimit??25,l=()=>e()?.limit??50,{events:g,addEvent:a,clearEvents:f,setEvents:S}=R({eose:i,eoseLimit:c,limit:l});I(D(()=>[r().mutedPubkeys,r().mutedKeywords],()=>{S(t=>t.filter(u=>!b(u)))},{defer:!0})),k(()=>{console.debug("subscription mounted",e()?.debugId,e()),p(()=>{console.debug("subscription unmount",e()?.debugId,e())})});const s=()=>{console.debug("startSubscription: start");const t=o();if(t==null)return;const{relayUrls:u,filters:d,options:x,onEvent:h,onEOSE:y,clientEventFilter:M,continuous:A=!0}=t;let m=!0;E+=1,f(),n(!1);const w=T().subscribeMany(u,d,x??{maxWait:12e3,onevent:v=>{h?.(v),!(M!=null&&!M(v))&&a(v)},oneose:()=>{i()||(y?.(),n(!0),A||(w.close(),m&&(m=!1,E-=1)))}});p(()=>{console.debug("startSubscription: end"),w.close(),m&&(m=!1,E-=1)})};return I(D(()=>[o()],()=>s())),{events:g,eose:i}};export{_ as u};
//# sourceMappingURL=useSubscription-Bs6X8iLJ.js.map
