import{j,c as C,w as k,m as p,b3 as M,o as q,B as I}from"./index-B7R5E62q.js";import{n as A,L as x,q as B,O as F}from"./SideBar-DtCkeG-j.js";let b=0;const{setActiveSubscriptions:K}=F();setInterval(()=>{K(b)},1e3);const N=({eose:e,limit:r,eoseLimit:E})=>{const[i,n]=C([]),o=[];let c;const l=()=>{n(s=>{const t=[...s];return o.forEach(u=>{x(t,u)}),t.slice(0,E())}),o.splice(0,o.length)},g=()=>{c==null&&(c=setTimeout(()=>{c=void 0,l()},100))},a=()=>{c!=null&&clearTimeout(c)},f=s=>{const t=s.created_at-B();if(!(t>300)){if(t>0){setTimeout(()=>f(s),t*1e3);return}e()?n(u=>{const d=[...u];return x(d,s),d.slice(0,r())}):(o.push(s),g())}},S=()=>{n([]),a()};return p(()=>{e()&&l()}),I(()=>{a()}),{events:i,setEvents:n,addEvent:f,clearEvents:S}},_=e=>{const{config:r,shouldMuteEvent:E}=j(),T=A(),[i,n]=C(!1),o=k(e),c=()=>e()?.eoseLimit??25,l=()=>e()?.limit??50,{events:g,addEvent:a,clearEvents:f,setEvents:S}=N({eose:i,eoseLimit:c,limit:l});p(M(()=>[r().mutedPubkeys,r().mutedKeywords],()=>{S(t=>t.filter(u=>!E(u)))},{defer:!0})),q(()=>{console.debug("subscription mounted",e()?.debugId,e()),I(()=>{console.debug("subscription unmount",e()?.debugId,e())})});const s=()=>{console.debug("startSubscription: start");const t=o();if(t==null)return;const{relayUrls:u,filters:d,options:D,onEvent:h,onEOSE:y,clientEventFilter:w,continuous:O=!0}=t;let m=!0;b+=1,f(),n(!1);const L=T().subscribeMany(u,d,D??{maxWait:12e3,onevent:v=>{h?.(v),!(w!=null&&!w(v))&&a(v)},oneose:()=>{i()||(y?.(),n(!0),O||(L.close(),m&&(m=!1,b-=1)))}});I(()=>{console.debug("startSubscription: end"),L.close(),m&&(m=!1,b-=1)})};return p(M(()=>[o()],()=>s())),{events:g,eose:i}};export{_ as u};
//# sourceMappingURL=useSubscription-C0Vv6F87.js.map
