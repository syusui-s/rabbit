{"version":3,"file":"useFollowings-DMjrA4Gj.js","sources":["../../src/components/ColumnItem.tsx","../../src/components/timeline/Timeline.tsx","../../src/components/column/LoadMore.tsx","../../src/nostr/useFollowings.ts"],"sourcesContent":["import { type Component, type JSX } from 'solid-js';\n\ntype ColumnItemProps = {\n  children: JSX.Element;\n};\n\nconst ColumnItem: Component<ColumnItemProps> = (props) => (\n  <div class=\"block shrink-0 overflow-hidden border-b border-border p-1\">{props.children}</div>\n);\n\nexport default ColumnItem;\n","import { For, type Component, Show } from 'solid-js';\n\nimport { type Event as NostrEvent } from 'nostr-tools/pure';\n\nimport ColumnItem from '@/components/ColumnItem';\nimport EventDisplay from '@/components/event/EventDisplay';\nimport useConfig from '@/core/useConfig';\n\nexport type TimelineProps = {\n  events: NostrEvent[];\n};\n\nconst Timeline: Component<TimelineProps> = (props) => {\n  const { shouldMuteEvent } = useConfig();\n\n  return (\n    <For each={props.events}>\n      {(event) => (\n        <Show when={!shouldMuteEvent(event)}>\n          <ColumnItem>\n            <EventDisplay event={event} />\n          </ColumnItem>\n        </Show>\n      )}\n    </For>\n  );\n};\n\nexport default Timeline;\n","import {\n  createSignal,\n  createMemo,\n  batch,\n  Show,\n  type JSX,\n  type Accessor,\n  type Component,\n} from 'solid-js';\n\nimport { type Event as NostrEvent } from 'nostr-tools/pure';\n\nimport ColumnItem from '@/components/ColumnItem';\nimport { useTranslation } from '@/i18n/useTranslation';\nimport { pickOldestEvent } from '@/nostr/event/comparator';\nimport epoch from '@/utils/epoch';\n\nexport type UseLoadMoreProps = {\n  duration: number | null;\n  onLoad?: () => void;\n};\n\nexport type UseLoadMore = {\n  setEvents: (event: NostrEvent[]) => void;\n  since: Accessor<number | undefined>;\n  until: Accessor<number | undefined>;\n  continuous: Accessor<boolean>;\n  loadLatest: () => void;\n  loadOld: () => void;\n};\n\nexport type LoadMoreProps = {\n  loadMore: UseLoadMore;\n  children: JSX.Element;\n  eose: boolean;\n};\n\nexport const useLoadMore = (propsProvider: () => UseLoadMoreProps): UseLoadMore => {\n  const props = createMemo(propsProvider);\n  const calcSince = (base: number): number | undefined => {\n    const { duration } = props();\n    if (duration == null) return undefined;\n    return base - duration;\n  };\n\n  const [events, setEvents] = createSignal<NostrEvent[]>([]);\n  const [since, setSince] = createSignal<number | undefined>(calcSince(epoch()));\n  const [until, setUntil] = createSignal<number | undefined>();\n  const continuous = () => until() == null;\n\n  const loadLatest = () => {\n    batch(() => {\n      setUntil(undefined);\n      setSince(calcSince(epoch()));\n    });\n\n    props().onLoad?.();\n  };\n\n  const loadOld = () => {\n    const oldest = pickOldestEvent(events());\n    if (oldest == null) return;\n    batch(() => {\n      setUntil(oldest.created_at);\n      setSince(calcSince(oldest.created_at));\n    });\n\n    props().onLoad?.();\n  };\n\n  return {\n    setEvents,\n    since,\n    until,\n    continuous,\n    loadLatest,\n    loadOld,\n  };\n};\n\nconst LoadMore: Component<LoadMoreProps> = (props) => {\n  const i18n = useTranslation();\n\n  return (\n    <>\n      <Show when={!props.loadMore.continuous()}>\n        <ColumnItem>\n          <button\n            class=\"flex h-12 w-full flex-col items-center justify-center hover:text-fg-secondary\"\n            onClick={() => props.loadMore.loadLatest()}\n          >\n            <span>{i18n.t('column.loadLatest')}</span>\n          </button>\n        </ColumnItem>\n      </Show>\n      {props.children}\n      <ColumnItem>\n        <button\n          class=\"flex h-12 w-full flex-col items-center justify-center hover:text-fg-secondary disabled:text-fg-secondary/30\"\n          disabled={!props.eose}\n          onClick={() => props.loadMore.loadOld()}\n        >\n          <span>{i18n.t('column.loadOld')}</span>\n        </button>\n      </ColumnItem>\n    </>\n  );\n};\n\nexport default LoadMore;\n","import { createMemo } from 'solid-js';\n\nimport { createQuery, useQueryClient, type UseQueryResult } from '@tanstack/solid-query';\nimport { type Event as NostrEvent } from 'nostr-tools/pure';\n\nimport { genericEvent } from '@/nostr/event';\nimport { latestEventQuery } from '@/nostr/query';\nimport { BatchedEventsTask, type FollowingsTask, registerTask } from '@/nostr/useBatchedEvents';\n\ntype Following = {\n  pubkey: string;\n  mainRelayUrl?: string;\n  petname?: string;\n};\n\ntype UseFollowingsProps = {\n  pubkey: string;\n};\n\nexport type UseFollowings = {\n  followings: () => Following[];\n  followingPubkeys: () => string[];\n  invalidateFollowings: () => Promise<void>;\n  query: UseQueryResult<NostrEvent | null>;\n};\n\nexport const queryKeyUseFollowings = (props: UseFollowingsProps | null) =>\n  ['useFollowings', props] as const;\n\nconst buildMethods = (dataProvider: () => NostrEvent | undefined | null) => {\n  const followings = () => {\n    const data = dataProvider();\n    if (data == null) return [];\n\n    const result: Following[] = [];\n\n    // TODO zodにする\n    const event = genericEvent(data);\n    event.pTags().forEach((tag) => {\n      const [, followingPubkey, mainRelayUrl, petname] = tag;\n\n      const following: Following = { pubkey: followingPubkey, petname };\n      if (mainRelayUrl != null && mainRelayUrl.length > 0) {\n        following.mainRelayUrl = mainRelayUrl;\n      }\n\n      result.push(following);\n    });\n\n    return result;\n  };\n\n  const followingPubkeys = (): string[] => followings().map((follow) => follow.pubkey);\n\n  return { followings, followingPubkeys, data: dataProvider };\n};\n\nexport const fetchLatestFollowings = async (\n  { pubkey }: UseFollowingsProps,\n  signal?: AbortSignal,\n) => {\n  const task = new BatchedEventsTask<FollowingsTask>({ type: 'Followings', pubkey });\n  registerTask({ task, signal });\n\n  const latestFollowings = await task.latestEventPromise();\n\n  return buildMethods(() => latestFollowings);\n};\n\nconst useFollowings = (propsProvider: () => UseFollowingsProps | null): UseFollowings => {\n  const queryClient = useQueryClient();\n  const props = createMemo(propsProvider);\n  const genQueryKey = createMemo(() => queryKeyUseFollowings(props()));\n\n  const query = createQuery(() => ({\n    queryKey: genQueryKey(),\n    queryFn: latestEventQuery<ReturnType<typeof genQueryKey>>({\n      taskProvider: ([, currentProps]) => {\n        if (currentProps == null) return null;\n        const { pubkey } = currentProps;\n        return new BatchedEventsTask<FollowingsTask>({ type: 'Followings', pubkey });\n      },\n      queryClient,\n    }),\n    staleTime: 5 * 60 * 1000, // 5 min\n    gcTime: 3 * 24 * 60 * 60 * 1000, // 3 days\n    refetchOnMount: true,\n    refetchOnWindowFocus: false,\n    refetchOnReconnect: false,\n    refetchInterval: 0,\n  }));\n\n  const invalidateFollowings = (): Promise<void> =>\n    queryClient.invalidateQueries({ queryKey: genQueryKey() });\n\n  return { ...buildMethods(() => query.data), invalidateFollowings, query };\n};\n\nexport default useFollowings;\n"],"names":["ColumnItem","_el$","_tmpl$","_$insert","props","children","Timeline","shouldMuteEvent","useConfig","_$createComponent","For","each","events","event","Show","when","EventDisplay","useLoadMore","propsProvider","createMemo","calcSince","base","duration","setEvents","createSignal","since","setSince","epoch","until","setUntil","continuous","loadLatest","batch","undefined","onLoad","loadOld","oldest","pickOldestEvent","created_at","LoadMore","i18n","useTranslation","loadMore","_el$2","firstChild","$$click","t","_$memo","_el$3","_tmpl$2","_el$4","_$effect","disabled","eose","_$delegateEvents","queryKeyUseFollowings","buildMethods","dataProvider","followings","data","result","genericEvent","tag","followingPubkey","mainRelayUrl","petname","following","follow","fetchLatestFollowings","pubkey","signal","task","BatchedEventsTask","registerTask","latestFollowings","useFollowings","queryClient","useQueryClient","genQueryKey","query","createQuery","latestEventQuery","currentProps","invalidateFollowings"],"mappings":"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"}