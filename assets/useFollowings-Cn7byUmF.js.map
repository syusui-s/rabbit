{"version":3,"file":"useFollowings-Cn7byUmF.js","sources":["../../src/components/ColumnItem.tsx","../../src/components/timeline/Timeline.tsx","../../src/components/column/LoadMore.tsx","../../src/nostr/useFollowings.ts"],"sourcesContent":["import { type Component, type JSX } from 'solid-js';\n\ntype ColumnItemProps = {\n  children: JSX.Element;\n};\n\nconst ColumnItem: Component<ColumnItemProps> = (props) => (\n  <div class=\"block shrink-0 overflow-hidden border-b border-border p-1\">{props.children}</div>\n);\n\nexport default ColumnItem;\n","import { For, type Component, Show } from 'solid-js';\n\nimport { type Event as NostrEvent } from 'nostr-tools/pure';\n\nimport ColumnItem from '@/components/ColumnItem';\nimport EventDisplay from '@/components/event/EventDisplay';\nimport useConfig from '@/core/useConfig';\n\nexport type TimelineProps = {\n  events: NostrEvent[];\n};\n\nconst Timeline: Component<TimelineProps> = (props) => {\n  const { shouldMuteEvent } = useConfig();\n\n  return (\n    <For each={props.events}>\n      {(event) => (\n        <Show when={!shouldMuteEvent(event)}>\n          <ColumnItem>\n            <EventDisplay event={event} />\n          </ColumnItem>\n        </Show>\n      )}\n    </For>\n  );\n};\n\nexport default Timeline;\n","import {\n  createSignal,\n  createMemo,\n  batch,\n  Show,\n  type JSX,\n  type Accessor,\n  type Component,\n} from 'solid-js';\n\nimport { type Event as NostrEvent } from 'nostr-tools/pure';\n\nimport ColumnItem from '@/components/ColumnItem';\nimport { useTranslation } from '@/i18n/useTranslation';\nimport { pickOldestEvent } from '@/nostr/event/comparator';\nimport epoch from '@/utils/epoch';\n\nexport type UseLoadMoreProps = {\n  duration: number | null;\n};\n\nexport type UseLoadMore = {\n  setEvents: (event: NostrEvent[]) => void;\n  since: Accessor<number | undefined>;\n  until: Accessor<number | undefined>;\n  continuous: Accessor<boolean>;\n  loadLatest: () => void;\n  loadOld: () => void;\n  setTopMarkerRef: (el: HTMLElement) => void;\n};\n\nexport type LoadMoreProps = {\n  loadMore: UseLoadMore;\n  children: JSX.Element;\n  eose: boolean;\n};\n\nexport const useLoadMore = (propsProvider: () => UseLoadMoreProps): UseLoadMore => {\n  const props = createMemo(propsProvider);\n  const calcSince = (base: number): number | undefined => {\n    const { duration } = props();\n    if (duration == null) return undefined;\n    return base - duration;\n  };\n\n  const [events, setEvents] = createSignal<NostrEvent[]>([]);\n  const [since, setSince] = createSignal<number | undefined>(calcSince(epoch()));\n  const [until, setUntil] = createSignal<number | undefined>();\n  const [topMarkerRef, setTopMarkerRef] = createSignal<HTMLElement | undefined>();\n  const continuous = () => until() == null;\n\n  const loadLatest = () => {\n    batch(() => {\n      setUntil(undefined);\n      setSince(calcSince(epoch()));\n    });\n    topMarkerRef()?.scrollIntoView();\n  };\n\n  const loadOld = () => {\n    const oldest = pickOldestEvent(events());\n    if (oldest == null) return;\n    batch(() => {\n      setUntil(oldest.created_at);\n      setSince(calcSince(oldest.created_at));\n    });\n    topMarkerRef()?.scrollIntoView();\n  };\n\n  return {\n    setEvents,\n    since,\n    until,\n    continuous,\n    loadLatest,\n    loadOld,\n    setTopMarkerRef,\n  };\n};\n\nconst LoadMore: Component<LoadMoreProps> = (props) => {\n  const i18n = useTranslation();\n\n  return (\n    <>\n      <Show when={!props.loadMore.continuous()}>\n        <div class=\"none\" ref={props.loadMore.setTopMarkerRef} />\n        <ColumnItem>\n          <button\n            class=\"flex h-12 w-full flex-col items-center justify-center hover:text-fg-secondary\"\n            onClick={() => props.loadMore.loadLatest()}\n          >\n            <span>{i18n.t('column.loadLatest')}</span>\n          </button>\n        </ColumnItem>\n      </Show>\n      {props.children}\n      <ColumnItem>\n        <button\n          class=\"flex h-12 w-full flex-col items-center justify-center hover:text-fg-secondary disabled:text-fg-secondary/30\"\n          disabled={!props.eose}\n          onClick={() => props.loadMore.loadOld()}\n        >\n          <span>{i18n.t('column.loadOld')}</span>\n        </button>\n      </ColumnItem>\n    </>\n  );\n};\n\nexport default LoadMore;\n","import { createMemo } from 'solid-js';\n\nimport { createQuery, useQueryClient, type CreateQueryResult } from '@tanstack/solid-query';\nimport { Event as NostrEvent } from 'nostr-tools/pure';\n\nimport { genericEvent } from '@/nostr/event';\nimport { latestEventQuery } from '@/nostr/query';\nimport { BatchedEventsTask, FollowingsTask, registerTask } from '@/nostr/useBatchedEvents';\n\ntype Following = {\n  pubkey: string;\n  mainRelayUrl?: string;\n  petname?: string;\n};\n\ntype UseFollowingsProps = {\n  pubkey: string;\n};\n\nexport type UseFollowings = {\n  followings: () => Following[];\n  followingPubkeys: () => string[];\n  invalidateFollowings: () => Promise<void>;\n  query: CreateQueryResult<NostrEvent | null>;\n};\n\nexport const queryKeyUseFollowings = (props: UseFollowingsProps | null) =>\n  ['useFollowings', props] as const;\n\nconst buildMethods = (dataProvider: () => NostrEvent | undefined | null) => {\n  const followings = () => {\n    const data = dataProvider();\n    if (data == null) return [];\n\n    const result: Following[] = [];\n\n    // TODO zodにする\n    const event = genericEvent(data);\n    event.pTags().forEach((tag) => {\n      const [, followingPubkey, mainRelayUrl, petname] = tag;\n\n      const following: Following = { pubkey: followingPubkey, petname };\n      if (mainRelayUrl != null && mainRelayUrl.length > 0) {\n        following.mainRelayUrl = mainRelayUrl;\n      }\n\n      result.push(following);\n    });\n\n    return result;\n  };\n\n  const followingPubkeys = (): string[] => followings().map((follow) => follow.pubkey);\n\n  return { followings, followingPubkeys, data: dataProvider };\n};\n\nexport const fetchLatestFollowings = async (\n  { pubkey }: UseFollowingsProps,\n  signal?: AbortSignal,\n) => {\n  const task = new BatchedEventsTask<FollowingsTask>({ type: 'Followings', pubkey });\n  registerTask({ task, signal });\n\n  const latestFollowings = await task.latestEventPromise();\n\n  return buildMethods(() => latestFollowings);\n};\n\nconst useFollowings = (propsProvider: () => UseFollowingsProps | null): UseFollowings => {\n  const queryClient = useQueryClient();\n  const props = createMemo(propsProvider);\n  const genQueryKey = createMemo(() => queryKeyUseFollowings(props()));\n\n  const query = createQuery(() => ({\n    queryKey: genQueryKey(),\n    queryFn: latestEventQuery<ReturnType<typeof genQueryKey>>({\n      taskProvider: ([, currentProps]) => {\n        if (currentProps == null) return null;\n        const { pubkey } = currentProps;\n        return new BatchedEventsTask<FollowingsTask>({ type: 'Followings', pubkey });\n      },\n      queryClient,\n    }),\n    staleTime: 5 * 60 * 1000, // 5 min\n    gcTime: 3 * 24 * 60 * 60 * 1000, // 3 days\n    refetchOnMount: true,\n    refetchOnWindowFocus: false,\n    refetchOnReconnect: false,\n    refetchInterval: 0,\n  }));\n\n  const invalidateFollowings = (): Promise<void> =>\n    queryClient.invalidateQueries({ queryKey: genQueryKey() });\n\n  return { ...buildMethods(() => query.data), invalidateFollowings, query };\n};\n\nexport default useFollowings;\n"],"names":["ColumnItem","_el$","_tmpl$","props","children","Timeline","shouldMuteEvent","useConfig","_$createComponent","For","each","events","Show","when","event","EventDisplay","useLoadMore","propsProvider","createMemo","calcSince","base","duration","setEvents","createSignal","since","setSince","epoch","until","setUntil","topMarkerRef","setTopMarkerRef","continuous","loadLatest","batch","undefined","scrollIntoView","loadOld","oldest","pickOldestEvent","created_at","LoadMore","i18n","useTranslation","loadMore","_ref$","_$use","_el$2","_tmpl$2","_el$3","firstChild","$$click","_$insert","t","_$memo","_el$4","_tmpl$3","_el$5","_$effect","disabled","eose","_$delegateEvents","queryKeyUseFollowings","buildMethods","dataProvider","followings","data","result","genericEvent","tag","followingPubkey","mainRelayUrl","petname","following","follow","fetchLatestFollowings","pubkey","signal","task","BatchedEventsTask","registerTask","latestFollowings","useFollowings","queryClient","useQueryClient","genQueryKey","query","createQuery","latestEventQuery","currentProps","invalidateFollowings"],"mappings":"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"}